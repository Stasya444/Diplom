import { prisma } from "~/server/utils/prisma";
import { hash } from "bcryptjs";
import jwt from "jsonwebtoken";

export default defineEventHandler(async (event) => {
  try {
    const body = await readBody(event);
    const { name, email, password, confirmPassword, role } = body;

    // üîí –í–∞–ª—ñ–¥–∞—Ü—ñ—è
    if (!name || !email || !password || !confirmPassword || !role) {
      return { success: false, message: "–£—Å—ñ –ø–æ–ª—è –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤—ñ" };
    }

    if (!email.includes("@") || email.length < 5) {
      return { success: false, message: "–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π email" };
    }

    if (password.length < 6) {
      return {
        success: false,
        message: "–ü–∞—Ä–æ–ª—å –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤",
      };
    }

    if (password !== confirmPassword) {
      return { success: false, message: "–ü–∞—Ä–æ–ª—ñ –Ω–µ –∑–±—ñ–≥–∞—é—Ç—å—Å—è" };
    }

    // üîê –•–µ—à—É–≤–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—é
    const hashedPassword = await hash(password, 10);

    // üßæ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    const user = await prisma.user.create({
      data: {
        name,
        email,
        password: hashedPassword,
        role,
      },
    });

    // ü™™ –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è JWT —Ç–æ–∫–µ–Ω–∞
    const token = jwt.sign({ id: user.id, role: user.role }, "secret_key", {
      expiresIn: "7d",
    });

    // üç™ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω–∞ –≤ cookie
    setCookie(event, "token", token, {
      httpOnly: true,
      path: "/",
      maxAge: 60 * 60 * 24 * 7, // 7 –¥–Ω—ñ–≤
    });

    return {
      success: true,
      message: "–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞",
      user: {
        id: user.id,
        name: user.name,
        role: user.role,
      },
    };
  } catch (error) {
    // ‚ö†Ô∏è –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–∫–∏ –¥—É–±–ª—ñ–∫–∞—Ç—É email
    if (
      typeof error === "object" &&
      error !== null &&
      "code" in error &&
      error.code === "P2002"
    ) {
      return {
        success: false,
        message: "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ —Ç–∞–∫–∏–º email –≤–∂–µ —ñ—Å–Ω—É—î",
      };
    }

    // üõ†Ô∏è –ó–∞–≥–∞–ª—å–Ω–∞ –ø–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
    console.error("–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó:", error);
    return {
      success: false,
      message: "–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞",
    };
  }
});
